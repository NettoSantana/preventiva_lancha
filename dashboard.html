<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Painel Interno â€” Preventiva NÃ¡utica</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <style>
    :root{
      --bg:#0b1020; --bg2:#0f172a; --card:#121a2e; --card2:#0f172b;
      --ink:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --line:#1f2a44;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 20% -10%, #12214a 0%, transparent 70%),
                  radial-gradient(1400px 800px at 120% 10%, #0b3a55 0%, transparent 60%),
                  linear-gradient(180deg,var(--bg),var(--bg2));
      color:var(--ink);
    }
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px;flex-wrap:wrap}
    .title{display:flex;gap:12px;align-items:center}

    .logo{
      width:56px;height:56px;border-radius:12px;object-fit:cover;
      box-shadow:0 10px 30px rgba(56,189,248,.25);
    }

    h1{margin:0;font-size:22px;letter-spacing:.3px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}

    .pill{
      padding:6px 10px;border-radius:999px;font-size:12px;
      background:#0a1325;border:1px solid var(--line);color:var(--muted);
    }

    .btn{
      padding:8px 12px;border-radius:10px;border:1px solid var(--line);
      background:#0a1325;color:var(--ink);
      cursor:pointer;
      font-size:13px;
    }

    .btn.active{
      border-color:rgba(56,189,248,.5);
      color:var(--accent);
    }

    .grid{display:grid;gap:14px;grid-template-columns:repeat(12,1fr);}
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
    }

    .card h2{
      margin:0 0 8px;font-size:14px;font-weight:700;
      color:var(--accent);letter-spacing:.4px;text-transform:uppercase;
    }

    .kpi{font-size:30px;font-weight:800;margin:6px 0}
    .muted{color:var(--muted);font-size:13px}

    .status{display:flex;gap:8px;align-items:center;font-size:13px;margin-top:6px}

    .dot{width:10px;height:10px;border-radius:999px;background:var(--muted);}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .table{width:100%;border-collapse:collapse;margin-top:6px;font-size:13px;}
    .table th,.table td{border-bottom:1px solid var(--line);padding:8px;text-align:left;}
    .table th{color:var(--muted);font-weight:600}

    .col-4{grid-column:span 4}
    .col-12{grid-column:span 12}

    .hide{display:none!important}
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="title">
      <img src="logo.jpeg" class="logo">
      <div>
        <h1>Painel Interno â€” Preventiva NÃ¡utica</h1>
        <div class="sub">BrasilSat â†’ API â†’ Flask â†’ Dashboard</div>
      </div>
    </div>

    <div class="row">
      <button class="btn active" id="tabPainel">Painel</button>
      <button class="btn" id="tabPreventiva">Preventiva</button>

      <!-- ðŸ”µ BOTÃƒO NOVO -->
      <button class="btn" id="btnPainelGeral">Painel Geral</button>

      <button class="btn" id="btnCliente">Cliente</button>

      <div class="pill" id="lastUpdate">Ãšltima atualizaÃ§Ã£o: --</div>
      <div class="pill">IMEI: <span id="imei">--</span></div>
    </div>
  </header>

  <!-- =======================
       PAINEL PRINCIPAL
  ======================== -->
  <section id="viewPainel" class="grid">

    <div class="card col-4">
      <div class="row">
        <h2>Hora da embarcaÃ§Ã£o</h2>
        <button class="btn" id="btnAjusteOffset">Ajuste</button>
      </div>
      <div class="kpi" id="horasMotor">--</div>
      <div class="muted">Hora real do motor (offset + horas totais)</div>
      <div class="muted">Offset atual: <span id="offsetAtual">0.0</span></div>
    </div>

    <div class="card col-4">
      <h2>Horas totais</h2>
      <div class="kpi" id="horasTotais">--</div>
      <div class="muted">Acumulado desde o inÃ­cio</div>
    </div>

    <div class="card col-4">
      <h2>Status do Motor</h2>
      <div class="kpi" id="motorStatus">--</div>
      <div class="status">
        <div class="dot" id="motorDot"></div>
        <div class="muted" id="motorHint">--</div>
      </div>
    </div>

    <div class="card col-4">
      <h2>TensÃ£o da Bateria</h2>
      <div class="kpi" id="tensao">-- V</div>
      <div class="muted" id="tensaoBadge">--</div>
    </div>

    <div class="card col-4">
      <h2>Horas paradas</h2>
      <div class="kpi" id="horasParadas">--</div>
      <div class="muted">Zera ao ligar</div>
    </div>

    <div class="card col-4">
      <h2>PrÃ³ximas atividades</h2>
      <div id="proxAtividades" class="muted">--</div>
    </div>

    <div class="card col-4">
      <h2>Alertas</h2>
      <div id="alertas" class="muted">--</div>
    </div>

    <div class="card col-4">
      <div class="row">
        <h2>Leituras recentes</h2>
        <button id="clearHistory" class="pill" style="cursor:pointer;border:none">limpar</button>
      </div>
      <table class="table" id="logs">
        <thead><tr><th>Hora</th><th class="right">V</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- =======================
       VIEW PREVENTIVA
  ======================== -->
  <section id="viewPreventiva" class="grid hide">
    <div class="card col-12">
      <div class="row">
        <h2>Plano de Preventiva</h2>
        <button class="btn" id="btnSalvarPlano">Salvar</button>
      </div>
      <div class="muted">Cadastre conforme o manual.</div>
    </div>

    <div class="card col-12">
      <div class="row">
        <div style="flex:2">
          <label>Nome</label>
          <input id="inpNome">
        </div>
        <div style="flex:1">
          <label>Primeira</label>
          <input id="inpPrimeira" type="number">
        </div>
        <div style="flex:1">
          <label>Intervalo</label>
          <input id="inpIntervalo" type="number">
        </div>
        <div style="flex:1">
          <label>Avisar</label>
          <input id="inpAvisar" type="number" value="10">
        </div>
        <button class="btn" id="btnAdicionar">Adicionar</button>
      </div>
    </div>

    <div class="card col-12">
      <h2>Itens</h2>
      <table class="table" id="tblPlano">
        <thead>
          <tr>
            <th>Tarefa</th>
            <th class="right">1Âª</th>
            <th class="right">Intervalo</th>
            <th class="right">Aviso</th>
            <th class="right">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="planoMsg" class="muted"></div>
    </div>
  </section>

</div>

<script>
  const ENDPOINT_DADOS="/dados";
  const ENDPOINT_PREV="/preventiva";
  const ENDPOINT_PLANO="/config/plano";
  const ENDPOINT_OFFSET="/config/offset";

  const tabPainel=document.getElementById("tabPainel");
  const tabPrev=document.getElementById("tabPreventiva");
  const viewPainel=document.getElementById("viewPainel");
  const viewPrev=document.getElementById("viewPreventiva");

  tabPainel.onclick=()=>{tabPainel.classList.add("active");tabPrev.classList.remove("active");viewPainel.classList.remove("hide");viewPrev.classList.add("hide");}
  tabPrev.onclick=()=>{tabPrev.classList.add("active");tabPainel.classList.remove("active");viewPrev.classList.remove("hide");viewPainel.classList.add("hide");loadPlano();}

  // ðŸ”µ NOVO BOTÃƒO: PAINEL GERAL
  document.getElementById("btnPainelGeral").onclick=()=>{
    window.location.href="/painel_geral";
  };

  // BotÃ£o Cliente jÃ¡ existia
  document.getElementById("btnCliente").onclick=()=>{
    window.location.href="/cadastro";
  };

  function fmt(ts){
    return new Date(ts*1000).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
  }

  // HistÃ³rico local
  let hist=JSON.parse(localStorage.getItem("hist")||"[]");
  function saveHist(){localStorage.setItem("hist",JSON.stringify(hist));}
  function pushHist(v,t){hist.push({v,t});if(hist.length>60)hist.shift();saveHist();renderLogs();}

  function renderLogs(){
    const tbody=document.querySelector("#logs tbody");
    tbody.innerHTML="";
    hist.slice().reverse().forEach(p=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${fmt(p.t)}</td><td class="right">${p.v.toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });
  }
  document.getElementById("clearHistory").onclick=()=>{hist=[];saveHist();renderLogs();}

  async function refresh(){
    const r=await fetch(ENDPOINT_DADOS);
    const d=await r.json();

    document.getElementById("imei").textContent=d.imei;
    document.getElementById("lastUpdate").textContent="Ãšltima: "+fmt(d.servertime);

    const unit=d.unidade_base||"h";

    const emb=(Number(d.horas_totais||0)+Number(d.offset||0));
    document.getElementById("horasMotor").textContent=emb.toFixed(2)+" "+unit;
    document.getElementById("offsetAtual").textContent=Number(d.offset||0).toFixed(2);

    let tot=d.medida_base==="km"?d.km_totais:d.horas_totais;
    document.getElementById("horasTotais").textContent=Number(tot).toFixed(2)+" "+unit;

    const ligado=d.motor_ligado;
    document.getElementById("motorStatus").textContent=ligado?"LIGADO":"DESLIGADO";
    document.getElementById("motorDot").className="dot "+(ligado?"ok":"");
    document.getElementById("motorHint").textContent=ligado?"IgniÃ§Ã£o ON":"IgniÃ§Ã£o OFF";

    const v=Number(d.tensao_bateria||0);
    document.getElementById("tensao").textContent=v.toFixed(2)+" V";
    document.getElementById("tensaoBadge").textContent=v<12?"Baixa":(v<12.3?"Meia carga":"OK");

    document.getElementById("horasParadas").textContent=Number(d.horas_paradas||0).toFixed(2)+" h";

    try{
      const r2=await fetch(ENDPOINT_PREV);
      const p=await r2.json();
      const arr=p.tarefas||[];
      const el=document.getElementById("proxAtividades");
      el.innerHTML=arr.length?arr.slice(0,3).map(t=>`â€¢ ${t.nome} (${t.faltam.toFixed(1)} ${unit})`).join("<br>"):"Nenhuma.";
    }catch{}

    const alerts=[];
    if(v<12)alerts.push("Bateria baixa.");
    if(ligado&&v<13.2)alerts.push("Sem carga adequada.");
    document.getElementById("alertas").innerHTML=alerts.length?alerts.join("<br>"):"Nenhum alerta.";

    pushHist(v,d.servertime);
  }

  setInterval(refresh,20000);
  refresh();

  // Preventiva CRUD
  let planoLocal=[];
  function renderPlano(){
    const tbody=document.querySelector("#tblPlano tbody");
    tbody.innerHTML="";
    planoLocal.forEach((it,i)=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${it.nome}</td>
        <td class="right">${it.primeira_execucao}</td>
        <td class="right">${it.intervalo}</td>
        <td class="right">${it.avisar_antes}</td>
        <td class="right"><button class="btn" data-i="${i}">Excluir</button></td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll("button[data-i]").forEach(btn=>{
      btn.onclick=()=>{
        const idx=btn.getAttribute("data-i");
        planoLocal.splice(idx,1);
        renderPlano();
      };
    });
  }

  async function loadPlano(){
    const r=await fetch(ENDPOINT_PLANO);
    const d=await r.json();
    planoLocal=d.plano||[];
    renderPlano();
  }

  document.getElementById("btnAdicionar").onclick=()=>{
    const nome=document.getElementById("inpNome").value.trim();
    const a=Number(document.getElementById("inpPrimeira").value);
    const b=Number(document.getElementById("inpIntervalo").value);
    const c=Number(document.getElementById("inpAvisar").value||10);
    if(!nome||!a||!b)return;
    planoLocal.push({nome,primeira_execucao:a,intervalo:b,avisar_antes:c});
    renderPlano();
  };

  document.getElementById("btnSalvarPlano").onclick=async()=>{
    const r=await fetch(ENDPOINT_PLANO,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({plano:planoLocal})
    });
    const d=await r.json();
    document.getElementById("planoMsg").textContent=d.mensagem||d.erro;
  };

  document.getElementById("btnAjusteOffset").onclick=async()=>{
    const atual=document.getElementById("offsetAtual").textContent;
    const novo=prompt("Novo offset:",atual);
    if(novo===null)return;
    const r=await fetch(ENDPOINT_OFFSET,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({offset:Number(novo)})
    });
    refresh();
  };
</script>

</body>
</html>