<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Painel Interno — Preventiva Náutica</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0b1020; --bg2:#0f172a; --card:#121a2e; --card2:#0f172b;
      --ink:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8;
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --line:#1f2a44;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 20% -10%, #12214a 0%, transparent 70%),
                  radial-gradient(1400px 800px at 120% 10%, #0b3a55 0%, transparent 60%),
                  linear-gradient(180deg,var(--bg),var(--bg2));
      color:var(--ink);
    }
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px;flex-wrap:wrap}
    .title{display:flex;gap:12px;align-items:center}
    .logo-img{
      width:56px;height:56px;border-radius:12px;object-fit:contain;background:#0a1325;
      border:1px solid var(--line); padding:6px;
      box-shadow:0 10px 30px rgba(56,189,248,.18);
    }
    h1{margin:0;font-size:22px;letter-spacing:.3px}
    .sub{color:var(--muted);font-size:13px;margin-top:2px}
    .pill{
      padding:6px 10px;border-radius:999px;font-size:12px;
      background:#0a1325;border:1px solid var(--line);color:var(--muted);
    }
    .btn{
      padding:8px 12px;border-radius:10px;border:1px solid var(--line);
      background:#0a1325;color:var(--ink);cursor:pointer;font-size:13px;
    }
    .grid{display:grid;gap:14px;grid-template-columns:repeat(12,1fr);}
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--line);
      border-radius:var(--radius); padding:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
    }
    .card h2{
      margin:0 0 8px;font-size:14px;font-weight:700;color:var(--accent);
      letter-spacing:.4px;text-transform:uppercase;
    }
    .kpi{font-size:30px;font-weight:800;margin:6px 0}
    .muted{color:var(--muted);font-size:13px}
    .status{display:flex;gap:8px;align-items:center;font-size:13px;margin-top:6px}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--muted);box-shadow:0 0 0 4px rgba(148,163,184,.12);}
    .dot.ok{background:var(--ok);box-shadow:0 0 0 4px rgba(34,197,94,.12)}
    .dot.warn{background:var(--warn);box-shadow:0 0 0 4px rgba(245,158,11,.12)}
    .dot.bad{background:var(--bad);box-shadow:0 0 0 4px rgba(239,68,68,.12)}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:10px;border:1px solid var(--line);
      font-size:12px;color:var(--muted);
    }
    .badge.ok{color:var(--ok);border-color:rgba(34,197,94,.35)}
    .badge.warn{color:var(--warn);border-color:rgba(245,158,11,.35)}
    .badge.bad{color:var(--bad);border-color:rgba(239,68,68,.35)}
    .col-4{grid-column:span 4}
    .col-5{grid-column:span 5}
    .col-7{grid-column:span 7}
    .col-8{grid-column:span 8}
    .col-12{grid-column:span 12}
    @media(max-width:900px){.col-4,.col-5,.col-7,.col-8{grid-column:span 12}}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .right{text-align:right}
    input{
      width:100%; padding:8px; border-radius:8px; border:1px solid var(--line);
      background:#0a1325; color:var(--ink); outline:none;
    }
    label{font-size:12px;color:var(--muted)}
    .mini{
      display:flex;gap:8px;align-items:end;margin-top:8px;
    }
    .mini > div{flex:1;min-width:120px;}
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="title">
      <!-- LOGO: coloque a imagem na mesma pasta do dashboard e renomeie pra logo.jpeg (ou troque o src) -->
      <img class="logo-img" src="sandbox:/mnt/data/WhatsApp Image 2025-11-10 at 12.23.49.jpeg" alt="Electro Auto Náutica" />
      <div>
        <h1>Painel Interno — Preventiva Náutica</h1>
        <div class="sub">BrasilSat → API → Flask → Dashboard (uso interno)</div>
      </div>
    </div>

    <div class="row">
      <div class="pill" id="lastUpdate">Última atualização: --</div>
      <div class="pill">IMEI: <span id="imei">--</span></div>
    </div>
  </header>

  <!-- =======================
       PAINEL PRINCIPAL
  ======================== -->
  <section id="viewPainel" class="grid">

    <!-- HORAS TOTAIS EMBARCAÇÃO (cumulativa) -->
    <div class="card col-4">
      <h2>Horas totais embarcação</h2>
      <div class="kpi" id="horasTotais">-- h</div>
      <div class="muted">Cumulativa (base manual + BrasilSat)</div>

      <div class="mini">
        <div>
          <label>Ajustar horas totais</label>
          <input id="inpHorasTotais" type="number" step="0.01" placeholder="Ex.: 575.74" />
        </div>
        <div style="flex:0.6">
          <button class="btn" id="btnSalvarHorasTotais">Salvar</button>
        </div>
      </div>
      <div class="muted" id="msgHorasTotais" style="margin-top:6px"></div>
    </div>

    <!-- HORÍMETRO BRASILSAT -->
    <div class="card col-4">
      <h2>Horas de motor (horímetro)</h2>
      <div class="kpi" id="horasMotor">-- h</div>
      <div class="muted">Horas ajustadas (BrasilSat + offset)</div>
    </div>

    <!-- HORAS PARADAS (zera quando liga) -->
    <div class="card col-4">
      <h2>Horas paradas</h2>
      <div class="kpi" id="horasParadas">-- h</div>
      <div class="muted">Zera a cada partida (quando motor liga)</div>
    </div>

    <!-- STATUS MOTOR -->
    <div class="card col-4">
      <h2>Status do Motor</h2>
      <div class="kpi" id="motorStatus">--</div>
      <div class="status">
        <div class="dot" id="motorDot"></div>
        <div class="muted" id="motorHint">--</div>
      </div>
    </div>

    <!-- TENSÃO BATERIA (sem gráfico) -->
    <div class="card col-4">
      <h2>Tensão da Bateria</h2>
      <div class="kpi" id="tensao">-- V</div>
      <div class="badge" id="tensaoBadge">--</div>
      <div class="muted" style="margin-top:6px">
        &lt;12.0V baixa | 12.0–12.5V ok parado | &gt;13.2V carregando
      </div>
    </div>

    <!-- PRÓXIMA TROCA ÓLEO -->
    <div class="card col-4">
      <h2>Próxima troca de óleo</h2>
      <div class="kpi"><span id="restanteOleo">--</span> h</div>
      <div class="muted">Ciclo padrão: 100h</div>
    </div>

    <!-- ALERTAS -->
    <div class="card col-12">
      <h2>Alertas</h2>
      <div id="alertas" class="muted">--</div>
    </div>

  </section>

</div>

<script>
  const ENDPOINT_DADOS = "/dados";
  const REFRESH_MS = 300000; // 5 minutos

  // ===== localStorage keys
  const KEY_BASE_TOTAL = "pn_horas_base_total_v1";
  const KEY_PARADAS = "pn_horas_paradas_state_v1";

  function fmtTime(ts){
    try{ return new Date(ts*1000).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit",second:"2-digit"}); }
    catch(e){ return "--"; }
  }

  function tensaoClass(v, motorLigado){
    if (v < 12.0) return "bad";
    if (motorLigado && v < 13.2) return "warn";
    if (!motorLigado && v < 12.3) return "warn";
    return "ok";
  }
  function tensaoLabel(v, motorLigado){
    if (v < 12.0) return "Bateria baixa";
    if (motorLigado && v < 13.2) return "Não carregando bem";
    if (!motorLigado && v < 12.3) return "Meia carga";
    return "Normal";
  }

  function setAlertas(arr){
    const el = document.getElementById("alertas");
    el.innerHTML = arr.length ? arr.map(a=>`• ${a}`).join("<br>") : "Sem alertas no momento.";
  }

  // ===== Horas totais cumulativas
  function getBaseTotal(){
    return Number(localStorage.getItem(KEY_BASE_TOTAL) || "0");
  }
  function setBaseTotal(v){
    localStorage.setItem(KEY_BASE_TOTAL, String(v));
  }

  // ===== Horas paradas (zera quando liga)
  function loadParadasState(){
    try{
      return JSON.parse(localStorage.getItem(KEY_PARADAS) || "{}");
    }catch(e){
      return {};
    }
  }
  function saveParadasState(st){
    localStorage.setItem(KEY_PARADAS, JSON.stringify(st));
  }

  function updateHorasParadas(servertime, motor_ligado){
    const st = loadParadasState();
    const last_ts = Number(st.last_ts || servertime);
    const last_motor = !!st.last_motor;
    let acc_s = Number(st.acc_s || 0);

    if (last_motor === false && motor_ligado === false){
      // continuou desligado -> acumula tempo parado
      const delta = Math.max(0, servertime - last_ts);
      acc_s += delta;
    }

    if (last_motor === false && motor_ligado === true){
      // acabou de ligar -> zera contador parado
      acc_s = 0;
    }

    st.last_ts = servertime;
    st.last_motor = motor_ligado;
    st.acc_s = acc_s;
    saveParadasState(st);

    return acc_s / 3600.0;
  }

  let lastHorasMotor = 0;

  async function refreshPainel(){
    const r = await fetch(ENDPOINT_DADOS, {cache:"no-store"});
    const d = await r.json();

    document.getElementById("imei").textContent = d.imei || "--";
    document.getElementById("lastUpdate").textContent =
      `Última atualização: ${fmtTime(d.servertime)} (${new Date().toLocaleDateString("pt-BR")})`;

    const hMotor = Number(d.horas_motor || 0);
    lastHorasMotor = hMotor;
    document.getElementById("horasMotor").textContent = hMotor.toFixed(2) + " h";

    const ligado = !!d.motor_ligado;
    document.getElementById("motorStatus").textContent = ligado ? "LIGADO" : "DESLIGADO";
    document.getElementById("motorDot").className = "dot " + (ligado ? "ok" : "");
    document.getElementById("motorHint").textContent = ligado ? "Ignição ON" : "Ignição OFF";

    const v = Number(d.tensao_bateria || 0);
    document.getElementById("tensao").textContent = v.toFixed(2) + " V";
    const cls = tensaoClass(v, ligado);
    const badge = document.getElementById("tensaoBadge");
    badge.className = "badge " + cls;
    badge.textContent = tensaoLabel(v, ligado);

    // horas totais cumulativas
    const base = getBaseTotal();
    const horasTotais = base + hMotor;
    document.getElementById("horasTotais").textContent = horasTotais.toFixed(2) + " h";

    // horas paradas
    const paradas_h = updateHorasParadas(Number(d.servertime||0), ligado);
    document.getElementById("horasParadas").textContent = paradas_h.toFixed(2) + " h";

    // próxima troca óleo (mantém 100h padrão)
    const restante = 100 - (hMotor % 100);
    document.getElementById("restanteOleo").textContent = restante.toFixed(2);

    const alerts = [];
    if (restante < 10) alerts.push(`Troca de óleo em menos de ${restante.toFixed(1)}h.`);
    if (v < 12.0) alerts.push("Tensão baixa: agendar carga/teste de bateria.");
    if (ligado && v < 13.2) alerts.push("Motor ligado sem tensão de carga adequada.");
    setAlertas(alerts);
  }

  // salvar horas totais: você digita o TOTAL REAL atual.
  // sistema calcula a base = total_digitado - horas_motor_brasilsat
  document.getElementById("btnSalvarHorasTotais").onclick = ()=>{
    const val = Number(document.getElementById("inpHorasTotais").value);
    if (!val || val < 0){
      document.getElementById("msgHorasTotais").textContent = "Digite um valor válido.";
      return;
    }
    const base = val - lastHorasMotor;
    setBaseTotal(base);
    document.getElementById("msgHorasTotais").textContent = "✅ Horas totais atualizadas.";
    document.getElementById("inpHorasTotais").value = "";
    refreshPainel();
  };

  refreshPainel();
  setInterval(refreshPainel, REFRESH_MS);
</script>
</body>
</html>
